<!DOCTYPE html>
<html>
<head>
  <title>Rx Zoo</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://npmcdn.com/hack@0.5.1" />
  <style type="text/css">
    @keyframes timeline-flow {
      from { transform: translateX(0) }
      to { transform: translateX(-64px) }
    }

    .timeline { animation: timeline-flow linear 1s infinite; }

    @keyframes event-flow {
      /* initial render outside viewbox because of blinking in #blink browsers */
      from { transform: translateX(-100px) }
      to { transform: translateX(-932px) }
    }

    .event-enter, .event-appear { animation: event-flow linear 13s; }

    #one { width: 100vw; max-width: 800px; }

    #one.paused .timeline, #one.paused .event-enter, #one.paused .event-appear {
      animation-play-state: paused;
    }

    #play-pause { font-size: 3em }
    #play-pause.pause::after { content: "⏸" }
    #play-pause.play::after { content: "▶️" }
    input { font-family: Menlo, Monaco, "Lucida Console", "Liberation Mono", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Courier New", monospace, serif }
  </style>
</head>
<body>
  <a href="https://gist.github.com/zemlanin/ce68944400c26ca864fdcd256a86ad04">source</a>
  <div id="one"></div><br/>
  <div id="play-pause" class="pause"></div><br/>
  <form id="args" action="javascript:void 0">
    <div id="fields">
      <div>
        <span style="color: gray">click$</span> = <input id="click$button" type="button" value="ok" />
      </div>
      <div>
        <span style="color: black">black$ =</span>
        <input id='black$' type="text" value="Rx.Observable.timer(0, 1000)" size="40" />
      </div>
      <div>
        <span style="color: red">red$ =</span>
        <input id='red$' type="text" value="black$.filter(function(v) { return v % 3 })" size="40" />
      </div>
      <div>
        <span style="color: blue">blue$ =</span>
        <input id='blue$' type="text" size="40" />
      </div>
      <div>
        <span style="color: green">green$ =</span>
        <input id='green$' type="text" size="40" />
      </div>
      <div>
        <span style="color: purple">purple$ =</span>
        <input id='purple$' type="text" size="40" />
      </div>
    </div>
    <input type="submit" />
  </form>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-with-addons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-dom.min.js"></script>

  <script type="text/javascript">
    (function () {
      const TEXT_COLORS = ['yellow', 'pink', 'orange', 'gray']
      const STREAM_COLORS = ['gray', 'black', 'red', 'blue', 'green', 'purple']
      const STREAM_VALUES = [
        'red$.map(function(v, i) { return i } )',
        'red$.debounce(1500)',
        'black$.take(3)',
        'black$.skip(3)',
        'black$.takeUntil(red$.skip(3))',
        'black$.share()',
        'black$.pausable(red$)',
      ]
      const h = React.createElement
      const pauseUpdate$ = new Rx.Subject()

      var disposable = {dispose: function () {}}

      function markWithTimestamp (v) { return {v: v, t: (new Date).getTime()} }
      function wrapToDisplay (s, i, arr) {
        const length = arr.length
        return s.timestamp().map(function (v) {
          const mappedArray = Array.from({length: length})
          mappedArray[i] = v
          return mappedArray
        })
      }
      function setAnimation (newPlayStatus) { pauseUpdate$.onNext(newPlayStatus) }
      function renderValueGroup (v, i) {
        return h(
          React.addons.CSSTransitionGroup,
          {
            transitionName: 'event',
            transitionAppear: true,
            transitionAppearTimeout: 0,
            transitionEnterTimeout: 0,
            transitionLeaveTimeout: 1,
            component: 'g',
            key: i,
            className: 'event',
          },
          v && h(
            'g',
            {key: `${v.value}.${v.timestamp}`},
            h('circle', {
              // initial render outside viewbox because of blinking in #blink browsers
              cx: 860,
              cy: 50 + i * 50,
              fill: STREAM_COLORS[i],
              r: 16,
            }),
            h('text', {
              // initial render outside viewbox because of blinking in #blink browsers
              x: 860,
              y: 50 + i * 50,
              fill: 'white',
              textAnchor: 'middle',
              dominantBaseline: 'central',
            }, v.value)
          )
        )
      }

      const click$ = (
        Rx.Observable.fromEvent(document.getElementById('click$button'), 'click').map('ok')
      )

      function updateSVG () {
        const static$ = [click$]

        const inputed$ = []
        const queryParams = []

        for (var input of Array.from(document.querySelectorAll('input[id$="$"]'))) {
          if (input.value) {
            inputed$.push(
              eval(`var ${input.id} = ${input.value}; ${input.id}`)
            )
            queryParams.push(`${input.id.replace('$', '')}=${encodeURIComponent(input.value)}`)
          } else {
            inputed$.push(
              eval(`var ${input.id} = Rx.Observable.empty(); ${input.id}`)
            )
          }
        }

        history.replaceState('', null, `?${queryParams.join('&')}`)
        const svgHeight = (inputed$.length + static$.length + 1) * 50
        const ticksArray = Array.from({length: 27}, function (v, i) {
          return [
              h('line', {
                x1: 864 - (i * 32),
                x2: 864 - (i * 32),
                y1: 0,
                y2: i % 2 ? 20 : 10,
                stroke: 'black',
                key: `${i}top`,
              }),
              h('line', {
                x1: 864 - (i * 32),
                x2: 864 - (i * 32),
                y1: svgHeight,
                y2: i % 2 ? svgHeight - 20 : svgHeight - 10,
                stroke: 'black',
                key: `${i}bottom`,
              })
            ]
        })

        disposable.dispose()
        disposable = Rx.Observable.merge(
          static$.concat(inputed$).map(wrapToDisplay)
        )
          .withLatestFrom(pauseUpdate$.startWith(true), function(b, r) {return r && b})
          .filter(Boolean)
          .subscribe(function (values) {
            const svgWidth = document.getElementById('one').clientWidth

            ReactDOM.render(
              h('svg',
                {
                  height: svgHeight,
                  width: svgWidth,
                  viewBox: `${800 - svgWidth} 0 ${svgWidth} ${svgHeight}`,
                },
                h('g', {className: 'timeline'}, ticksArray),
                values.map(renderValueGroup)
              ),
              document.getElementById('one')
            )
          })
          Rx.Observable.merge(inputed$).subscribeOnCompleted(function () {
            setTimeout(setAnimation, 100, false)
          })
      }

      for (var input of Array.from(document.querySelectorAll('input[id$="$"]'))) {
        const paramName = input.id.replace('$', '')
        const inputParam = location.search.match(new RegExp(`\\W${paramName}=([^&]+)`))
        if (inputParam && inputParam[1]) { input.value = decodeURIComponent(inputParam[1]) }
      }

      updateSVG()
      document.getElementById('args').onsubmit = function (e) { setAnimation(true); updateSVG() }
      document.getElementById('play-pause').onclick = function () { setAnimation(document.getElementById('one').classList.contains('paused')) }
      pauseUpdate$.subscribe(function (newPlayStatus) {
        const button = document.getElementById('play-pause')

        if (newPlayStatus) {
          document.getElementById('one').classList.remove('paused')
          button.classList.add('pause')
          button.classList.remove('play')
        } else {
          document.getElementById('one').classList.add('paused')
          button.classList.add('play')
          button.classList.remove('pause')
        }
      })
    })();
  </script>
</body>
</html>
