<!DOCTYPE html>
<html>
<head>
  <title>Rx Zoo</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://npmcdn.com/hack@0.5.1" />
  <style type="text/css">
    @keyframes timeline-flow {
      from { transform: translateX(0) }
      to { transform: translateX(-64px) }
    }

    .timeline { animation: timeline-flow linear 1s infinite; }

    @keyframes event-flow {
      from { transform: translateX(0) }
      to { transform: translateX(-960px) }
    }

    .event-enter, .event-appear { animation: event-flow linear 15s; }

    #one { width: 100vw; max-width: 800px; }

    #one.paused .timeline, #one.paused .event-enter, #one.paused .event-appear {
      animation-play-state: paused;
    }

    #play-pause { font-size: 5em }
    #play-pause.pause::after { content: "⏸" }
    #play-pause.play::after { content: "▶️" }
  </style>
</head>
<body>
  <a href="https://gist.github.com/zemlanin/ce68944400c26ca864fdcd256a86ad04">source</a>
  <div id="one"></div><br/>
  <div id="play-pause" class="pause"></div><br/>
  <form id="args" action="javascript:void 0">
    <div id="fields">
      <div>
        <span style="color: gray">click$</span> = <input id="click$button" type="button" value="ok" />
      </div>
      <div>
        <span style="color: black">black$ =</span>
        <input id='black$' type="text" value="Rx.Observable.timer(0, 1000)" size="40" />
      </div>
      <div>
        <span style="color: red">red$ =</span>
        <input id='red$' type="text" value="black$.filter(function(v) { return v % 3 })" size="40" />
      </div>
      <div>
        <span style="color: blue">blue$ =</span>
        <input id='blue$' type="text" size="40" />
      </div>
      <div>
        <span style="color: green">green$ =</span>
        <input id='green$' type="text" size="40" />
      </div>
    </div>
    <input type="submit" />
  </form>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-with-addons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-dom.min.js"></script>

  <script type="text/javascript">
    (function () {
      const TEXT_COLORS = ['yellow', 'pink', 'orange', 'gray']
      const STREAM_COLORS = ['gray', 'black', 'red', 'blue', 'green']
      const STREAM_VALUES = [
        'red$.map(function(v, i) { return i } )',
        'red$.debounce(1500)',
        'black$.take(3)',
        'black$.skip(3)',
        'black$.takeUntil(red$.skip(3))',
        'black$.share()',
        'black$.pausable(red$)',
      ]
      const h = React.createElement
      const pauseUpdate$ = new Rx.Subject()

      var disposable = {dispose: function () {}}

      function mapToDisplay (v, i) { return {v: v, t: (new Date).getTime()} }
      function inputValue (v) { return v.value }
      function argsToArray () { return Array.from(arguments) }
      function startWithNull (s) { return s.startWith(null) }
      function setAnimation (newPlayStatus) { pauseUpdate$.onNext(newPlayStatus) }
      function timerStream (v) { return Rx.Observable.timer(14000).map(null).startWith(v) }

      const click$ = (
        Rx.Observable.fromEvent(document.getElementById('click$button'), 'click')
        .map('ok')
        .map(mapToDisplay)
        .flatMapLatest(timerStream)
      )

      function updateSVG () {
        const textColor = 'white' // TEXT_COLORS[parseInt(Math.random() * TEXT_COLORS.length)]
        const static$ = [click$]

        const inputed$ = []
        const queryParams = []

        for (var input of Array.from(document.querySelectorAll('input[id$="$"]'))) {
          if (input.value) {
            inputed$.push(
              eval(`var ${input.id} = ${input.value}; ${input.id}`)
                .map(mapToDisplay)
                .flatMapLatest(timerStream)
            )
            queryParams.push(`${input.id.replace('$', '')}=${encodeURIComponent(input.value)}`)
          }
        }

        history.replaceState('', null, `?${queryParams.join('&')}`)

        disposable.dispose()
        disposable = Rx.Observable.combineLatest(
          static$.concat(inputed$).map(startWithNull),
          argsToArray
        )
          .withLatestFrom(pauseUpdate$.startWith(true), function(b, r) {return r && b})
          .filter(Boolean)
          .subscribe(function (values) {
            const svgHeight = 50 + values.length * 50
            const svgWidth = document.getElementById('one').clientWidth

            ReactDOM.render(
              h('svg',
                {
                  height: svgHeight,
                  width: svgWidth,
                  viewBox: `0 0 ${svgWidth} ${svgHeight}`,
                },
                h('g', {className: 'timeline'},
                  Array.from({length: parseInt(svgWidth / 32) + 2}, function (v, i) {
                    return [
                      h('line', {
                        x1: svgWidth - ((i - 2) * 32),
                        x2: svgWidth - ((i - 2) * 32),
                        y1: 0,
                        y2: i % 2 ? 20 : 10,
                        stroke: 'black',
                        key: `${i}top`,
                      }),
                      h('line', {
                        x1: svgWidth - ((i - 2) * 32),
                        x2: svgWidth - ((i - 2) * 32),
                        y1: svgHeight,
                        y2: i % 2 ? svgHeight - 20 : svgHeight - 10,
                        stroke: 'black',
                        key: `${i}bottom`,
                      })
                    ]
                  })
                ),
                values.map(function (v, i) { return v && h(
                  React.addons.CSSTransitionGroup,
                  {
                    transitionName: 'event',
                    transitionAppear: true,
                    transitionAppearTimeout: 0,
                    transitionEnterTimeout: 0,
                    transitionLeaveTimeout: 1,
                    component: 'g',
                    key: i,
                  },
                  h('g', {key: `${v.v}.${v.t}`},
                    h('circle', {
                      cx: svgWidth - 40,
                      cy: 50 + i * 50,
                      fill: STREAM_COLORS[i],
                      r: 16,
                    }),
                    h('text', {
                      x: svgWidth - 40,
                      y: 50 + i * 50,
                      fill: textColor,
                      textAnchor: 'middle',
                      dominantBaseline: 'central',
                    }, v.v)
                  ))
                })
              ),
              document.getElementById('one')
            )
          })
          Rx.Observable.merge(inputed$).subscribeOnCompleted(function () {
            setTimeout(setAnimation, 100, false)
          })
      }

      for (var input of Array.from(document.querySelectorAll('input[id$="$"]'))) {
        const paramName = input.id.replace('$', '')
        const inputParam = location.search.match(new RegExp(`\\W${paramName}=([^&]+)`))
        if (inputParam && inputParam[1]) { input.value = decodeURIComponent(inputParam[1]) }
      }

      updateSVG()
      document.getElementById('args').onsubmit = function (e) { setAnimation(true); updateSVG() }
      document.getElementById('play-pause').onclick = function () { setAnimation(document.getElementById('one').classList.contains('paused')) }
      pauseUpdate$.subscribe(function (newPlayStatus) {
        const button = document.getElementById('play-pause')

        if (newPlayStatus) {
          document.getElementById('one').classList.remove('paused')
          button.classList.add('pause')
          button.classList.remove('play')
        } else {
          document.getElementById('one').classList.add('paused')
          button.classList.add('play')
          button.classList.remove('pause')
        }
      })
    })();
  </script>
</body>
</html>
