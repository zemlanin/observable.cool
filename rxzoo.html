<!DOCTYPE html>
<html>
<head>
  <title>Rx Zoo</title>
  <link rel="stylesheet" href="https://npmcdn.com/hack@0.5.1" />
  <style type="text/css">
    @keyframes timeline-flow {
      from { transform: translateX(0) }
      to { transform: translateX(-40px) }
    }

    .timeline { animation: timeline-flow linear 1s infinite; }

    @keyframes event-flow {
      from { transform: translateX(0) }
      to { transform: translateX(-400px) }
    }

    .event-enter, .event-appear { animation: event-flow linear 10s; }
  </style>
</head>
<body>
  <div id="one"></div>
  <form id="args" action="javascript:void 0">
    <div id="fields">
      <div>
        black$ =
        <input id='black$' type="text" value="Rx.Observable.timer(0, 1000)" size="40" />
      </div>
      <div>
        red$ =
        <input id='red$' type="text" value="black$.filter(function(v) { return v % 3 })" size="40" />
      </div>
    </div>
    <input type="button" id="add" value="+" />
    <input type="submit" />
  </form>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-with-addons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.1/react-dom.min.js"></script>

  <script type="text/javascript">
    (function () {
      const TEXT_COLORS = ['yellow', 'pink', 'orange', 'gray']
      const STREAM_COLORS = ['black', 'red', 'blue', 'green']
      const STREAM_VALUES = [
        'red$.map(function(v, i) { return i } )',
        'red$.debounce(1500)',
        'black$.take(3)',
        'black$.skip(3)',
        'black$.takeUntil(red$.skip(3))',
      ]
      const h = React.createElement

      var disposable = {dispose: function () {}}

      function mapToDisplay (v, i) { return {v: v, t: (new Date)} }
      function inputValue (v) { return v.value }
      function argsToArray () { return Array.from(arguments) }

      function updateSVG () {
        const textColor = 'white' // TEXT_COLORS[parseInt(Math.random() * TEXT_COLORS.length)]
        const reducedInput$ = []

        for (var input of Array.from(document.querySelectorAll('input[id$="$"]'))) {
          if (input.value) {
            reducedInput$.push(
              eval(`var ${input.id} = ${input.value}; ${input.id}`).map(mapToDisplay).startWith(null)
            )
          }
        }

        disposable.dispose()
        disposable = Rx.Observable.combineLatest(reducedInput$, argsToArray)
          .subscribe(function (values) {
            ReactDOM.render(
              h('svg', {height: 30 + reducedInput$.length * 50},
                h('g', {className: 'timeline'},
                  Array.from({length: 20}, function (v, i) { return h(
                    'line', {
                      x1: i * 20 - 10,
                      x2: i * 20 - 10,
                      y1: 0,
                      y2: i % 2 ? 20 : 10,
                      stroke: 'black',
                    }
                  )})
                ),
                values.map(function (v, i) { return v && h(
                  React.addons.CSSTransitionGroup,
                  {
                    transitionName: 'event',
                    transitionAppear: true,
                    transitionLeaveTimeout: 1,
                    component: 'g',
                    key: i,
                  },
                  h('g', {key: `${v.v}.${v.t}`},
                    h('circle', {
                      cx: 250,
                      cy: 50 + i * 50,
                      fill: STREAM_COLORS[i],
                      r: 15,
                    }),
                    h('text', {
                      x: 250,
                      y: 55 + i * 50,
                      fill: textColor,
                      textAnchor: 'middle',
                    }, v.v)
                  ))
                })
              ),
              document.getElementById('one')
            )
          })
      }

      updateSVG()
      document.getElementById('args').onsubmit = function (e) { updateSVG() }
      document.getElementById('add').onclick = function (e) {
        const existingInputs = document.querySelectorAll('input[id$="$"]').length

        if (existingInputs === STREAM_COLORS.length) { return }
        else if (existingInputs === STREAM_COLORS.length - 1) { e.target.remove() }

        const div = document.createElement('div')
        const input = document.createElement('input')
        div.textContent = STREAM_COLORS[existingInputs] + '$ = '
        input.id = input.name = STREAM_COLORS[existingInputs] + '$'
        input.type = 'text'
        input.size = 40
        input.value = STREAM_VALUES[parseInt(Math.random() * STREAM_VALUES.length)]

        document.getElementById('fields').appendChild(div).appendChild(input)
      }
    })();
  </script>
</body>
</html>
